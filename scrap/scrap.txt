-- Theme 3: Product Optimization
-- Question 1: What are the top 10 best and worst-selling products by revenue, and what is their profitability?
-- This helps identify hero products to promote and laggards to potentially discontinue.

-- Using two CTEs to get top and bottom products, then UNION them together.

-- Top 10 Products
WITH RankedTop AS (
    SELECT TOP 10
        'Top 10' AS Category,
        p.ProductName,
        p.CategoryName,
        p.SubcategoryName,
        FORMAT(SUM(fs.LineTotal), 'C', 'en-US') AS TotalRevenue,
        FORMAT(SUM(fs.LineProfit), 'C', 'en-US') AS TotalProfit,
        FORMAT(AVG(fs.LineProfit / NULLIF(fs.LineTotal, 0)), 'P') AS ProfitMargin
    FROM Analytics.Fact_Sales fs
    JOIN Analytics.Dim_Product p ON fs.ProductID = p.ProductID
    GROUP BY p.ProductName, p.CategoryName, p.SubcategoryName
    ORDER BY SUM(fs.LineTotal) DESC
),
-- Bottom 10 Products
RankedBottom AS (
    SELECT TOP 10
        'Bottom 10' AS Category,
        p.ProductName,
        p.CategoryName,
        p.SubcategoryName,
        FORMAT(SUM(fs.LineTotal), 'C', 'en-US') AS TotalRevenue,
        FORMAT(SUM(fs.LineProfit), 'C', 'en-US') AS TotalProfit,
        FORMAT(AVG(fs.LineProfit / NULLIF(fs.LineTotal, 0)), 'P') AS ProfitMargin
    FROM Analytics.Fact_Sales fs
    JOIN Analytics.Dim_Product p ON fs.ProductID = p.ProductID
    GROUP BY p.ProductName, p.CategoryName, p.SubcategoryName
    ORDER BY SUM(fs.LineTotal) ASC
)
SELECT * FROM RankedTop
UNION ALL
SELECT * FROM RankedBottom;



-- Theme 3: Product Optimization
-- Question 2: What products are most frequently purchased together? (Market Basket Analysis)
-- This is a classic data mining technique to uncover cross-selling opportunities.

WITH OrderProducts AS (
    -- We only need SalesOrderID and ProductName for this analysis
    SELECT
        fs.SalesOrderID,
        p.ProductName
    FROM
        Analytics.Fact_Sales fs
    JOIN
        Analytics.Dim_Product p ON fs.ProductID = p.ProductID
)
-- Self-join the table to find pairs of products bought in the same order.
SELECT
-- TOP 10
    a.ProductName AS ProductA,
    b.ProductName AS ProductB,
    COUNT(*) AS Frequency
FROM
    OrderProducts a
JOIN
    OrderProducts b ON a.SalesOrderID = b.SalesOrderID AND a.ProductName < b.ProductName -- a.ProductName < b.ProductName avoids duplicates (A,B) and self-pairs (A,A)
GROUP BY
    a.ProductName,
    b.ProductName
ORDER BY
    Frequency DESC
 


-- Theme 3: Product Optimization
-- Question 3: How does product category performance differ across sales channels?
-- This query uses a PIVOT operator to compare channel revenues side-by-side for each product category.

SELECT
    CategoryName,
    FORMAT(ISNULL([Online], 0), 'C', 'en-US') AS OnlineRevenue,
    FORMAT(ISNULL([Reseller], 0), 'C', 'en-US') AS ResellerRevenue
FROM (
    -- Step 1: Get the revenue for each product category and channel
    SELECT
        p.CategoryName,
        fs.Channel,
        fs.LineTotal
    FROM
        Analytics.Fact_Sales fs
    JOIN
        Analytics.Dim_Product p ON fs.ProductID = p.ProductID
) AS SourceData
PIVOT (
    -- Step 2: Pivot the data to create columns for each channel
    SUM(LineTotal)
    FOR Channel IN ([Online], [Reseller])
) AS PivotTable
ORDER BY
    CategoryName;

-- Theme 3: Product Optimization
-- Question 4: What is the impact of discounts on sales volume and profitability for key subcategories?
-- This query analyzes the relationship between discounts, sales quantity, and profit.

WITH DiscountAnalysis AS (
    SELECT
        p.CategoryName,
        p.SubcategoryName,
        fs.UnitPriceDiscount,
        SUM(fs.OrderQty) as TotalQuantitySold,
        SUM(fs.LineProfit) as TotalProfit
    FROM
        Analytics.Fact_Sales fs
    JOIN
        Analytics.Dim_Product p ON fs.ProductID = p.ProductID
    WHERE
        p.SubcategoryName IN ('Mountain Bikes', 'Road Bikes', 'Jerseys', 'Helmets') -- Focus on key subcategories
    GROUP BY
        p.CategoryName,
        p.SubcategoryName,
        fs.UnitPriceDiscount
)
SELECT
    CategoryName,
    SubcategoryName,
    FORMAT(UnitPriceDiscount, 'P') AS DiscountPercentage,
    TotalQuantitySold,
    FORMAT(TotalProfit, 'C', 'en-US') AS TotalProfit,
    -- Calculate profit per unit sold at this discount level
    FORMAT(TotalProfit / NULLIF(TotalQuantitySold, 0), 'C', 'en-US') AS ProfitPerUnit
FROM
    DiscountAnalysis
WHERE
    UnitPriceDiscount > 0 -- Only look at sales where a discount was applied
ORDER BY
    SubcategoryName,
    UnitPriceDiscount;

