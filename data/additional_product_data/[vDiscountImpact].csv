
-- Theme 3: Product Optimization
-- Question 4: What is the impact of discounts on sales volume and profitability for key subcategories?
-- This query analyzes the relationship between discounts, sales quantity, and profit.
WITH DiscountBuckets AS (
  SELECT
    p.CategoryName,
    p.SubcategoryName,
    fs.UnitPriceDiscount,
    CASE
      WHEN fs.UnitPriceDiscount BETWEEN 0 AND 0.05 THEN '0-5%'
      WHEN fs.UnitPriceDiscount > 0.05 AND fs.UnitPriceDiscount <= 0.15 THEN '5-15%'
      WHEN fs.UnitPriceDiscount > 0.15 AND fs.UnitPriceDiscount <= 0.30 THEN '15-30%'
      ELSE '>30%'
    END AS DiscountBucket,
    fs.OrderQty,
    fs.LineProfit
  FROM Analytics.Fact_Sales fs
  JOIN Analytics.Dim_Product p ON fs.ProductID = p.ProductID
  WHERE p.SubcategoryName IN ('Mountain Bikes', 'Road Bikes', 'Jerseys', 'Helmets')
)
SELECT
  CategoryName,
  SubcategoryName,
  DiscountBucket,
  SUM(OrderQty) AS TotalQuantitySold,
  FORMAT(SUM(LineProfit),'C', 'en-US') AS TotalProfit,
  FORMAT(CASE WHEN SUM(OrderQty)=0 THEN NULL ELSE SUM(LineProfit) * 1.0 / SUM(OrderQty) END, 'C', 'en-US') AS ProfitPerUnit
FROM DiscountBuckets
GROUP BY CategoryName, SubcategoryName, DiscountBucket
ORDER BY SubcategoryName, DiscountBucket;

CategoryName,SubcategoryName,DiscountBucket,TotalQuantitySold,TotalProfit,ProfitPerUnit
Bikes,Mountain Bikes,>30%,838,-709353.866100,-846.484327
Accessories,Helmets,5-15%,1172,1212.581280,1.034625
Bikes,Road Bikes,0-5%,46837,2926485.692612,62.482347
Clothing,Jerseys,5-15%,57,-971.503040,-17.043912
Bikes,Road Bikes,15-30%,304,-97972.724800,-322.278700
Accessories,Helmets,0-5%,18369,227116.559697,12.364122
Clothing,Jerseys,0-5%,22654,-148915.654226,-6.573481
Bikes,Road Bikes,5-15%,55,-17438.547500,-317.064500
Bikes,Mountain Bikes,0-5%,27483,5617395.758580,204.395290
