-- Theme 3: Product Optimization
-- Question 1: What are the top 10 best and worst-selling products by revenue, and what is their profitability?
-- This helps identify hero products to promote and laggards to potentially discontinue.

-- Using two CTEs to get top and bottom products, then UNION them together.

WITH ProdAgg AS (
  SELECT
    p.ProductID,
    p.ProductName,
    p.CategoryName,
    p.SubcategoryName,
    SUM(fs.LineTotal) AS TotalRevenue,
    SUM(fs.LineProfit) AS TotalProfit
  FROM Analytics.Fact_Sales fs
  JOIN Analytics.Dim_Product p ON fs.ProductID = p.ProductID
  GROUP BY p.ProductID, p.ProductName, p.CategoryName, p.SubcategoryName
),
Top10 AS (
  SELECT TOP (10) 'Top 10' AS Category, ProductID, ProductName, CategoryName, SubcategoryName,  TotalRevenue,  TotalProfit
  FROM ProdAgg ORDER BY TotalRevenue DESC
),
Bottom10 AS (
  SELECT TOP (10) 'Bottom 10' AS Category, ProductID, ProductName, CategoryName, SubcategoryName,TotalRevenue,  TotalProfit
  FROM ProdAgg ORDER BY TotalRevenue ASC
)
SELECT *, FORMAT(CASE WHEN TotalRevenue = 0 THEN NULL ELSE TotalProfit * 1.0 / TotalRevenue END, 'P') AS ProfitMargin FROM Top10
UNION ALL
SELECT *, FORMAT(CASE WHEN TotalRevenue = 0 THEN NULL ELSE TotalProfit * 1.0 / TotalRevenue END, 'P') AS ProfitMargin FROM Bottom10;


Category,ProductID,ProductName,CategoryName,SubcategoryName,TotalRevenue,TotalProfit,ProfitMargin
Top 10,782,"Mountain-200 Black, 38",Bikes,Mountain Bikes,4400592.800400,673444.470300,0.153034
Top 10,783,"Mountain-200 Black, 42",Bikes,Mountain Bikes,4009494.761841,674216.578641,0.168154
Top 10,779,"Mountain-200 Silver, 38",Bikes,Mountain Bikes,3693678.025272,663784.942272,0.179708
Top 10,780,"Mountain-200 Silver, 42",Bikes,Mountain Bikes,3438478.860423,611084.897423,0.177719
Top 10,781,"Mountain-200 Silver, 46",Bikes,Mountain Bikes,3434256.941928,629644.129928,0.183342
Top 10,784,"Mountain-200 Black, 46",Bikes,Mountain Bikes,3309673.216908,666740.692608,0.201452
Top 10,793,"Road-250 Black, 44",Bikes,Road Bikes,2516857.314918,-36367.136882,-0.014449
Top 10,794,"Road-250 Black, 48",Bikes,Road Bikes,2347655.953454,18343.999254,0.007813
Top 10,795,"Road-250 Black, 52",Bikes,Road Bikes,2012447.775000,76537.639500,0.038032
Top 10,753,"Road-150 Red, 56",Bikes,Road Bikes,1847818.628000,406079.279200,0.219761
Bottom 10,911,LL Road Seat/Saddle,Components,Saddles,162.720000,42.307000,0.259998
Bottom 10,710,"Mountain Bike Socks, L",Clothing,Socks,513.000000,207.333000,0.404157
Bottom 10,897,"LL Touring Frame - Blue, 58",Components,Touring Frames,800.208000,0.800400,0.001000
Bottom 10,943,"LL Mountain Frame - Black, 40",Components,Mountain Frames,1198.992000,104.712000,0.087333
Bottom 10,914,LL Touring Seat/Saddle,Components,Saddles,1480.752000,384.993700,0.259998
Bottom 10,942,"ML Mountain Frame-W - Silver, 38",Components,Mountain Frames,1529.178000,133.548100,0.087333
Bottom 10,946,LL Touring Handlebars,Components,Handlebars,1548.624000,402.640000,0.259998
Bottom 10,805,LL Headset,Components,Headsets,1949.400000,506.844000,0.260000
Bottom 10,915,ML Touring Seat/Saddle,Components,Saddles,1972.656000,512.887200,0.259998
Bottom 10,927,"LL Mountain Frame - Black, 52",Components,Mountain Frames,2248.110000,196.335000,0.087333
